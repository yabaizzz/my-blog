{"ast":null,"code":"import { useRect } from \"@vant/use\";\nimport { loadImageAsync } from \"./util.mjs\";\nimport { noop } from \"../../utils/index.mjs\";\n\nclass ReactiveListener {\n  constructor({\n    el,\n    src,\n    error,\n    loading,\n    bindType,\n    $parent,\n    options,\n    cors,\n    elRenderer,\n    imageCache\n  }) {\n    this.el = el;\n    this.src = src;\n    this.error = error;\n    this.loading = loading;\n    this.bindType = bindType;\n    this.attempt = 0;\n    this.cors = cors;\n    this.naturalHeight = 0;\n    this.naturalWidth = 0;\n    this.options = options;\n    this.$parent = $parent;\n    this.elRenderer = elRenderer;\n    this.imageCache = imageCache;\n    this.performanceData = {\n      loadStart: 0,\n      loadEnd: 0\n    };\n    this.filter();\n    this.initState();\n    this.render(\"loading\", false);\n  }\n\n  initState() {\n    if (\"dataset\" in this.el) {\n      this.el.dataset.src = this.src;\n    } else {\n      this.el.setAttribute(\"data-src\", this.src);\n    }\n\n    this.state = {\n      loading: false,\n      error: false,\n      loaded: false,\n      rendered: false\n    };\n  }\n\n  record(event) {\n    this.performanceData[event] = Date.now();\n  }\n\n  update({\n    src,\n    loading,\n    error\n  }) {\n    const oldSrc = this.src;\n    this.src = src;\n    this.loading = loading;\n    this.error = error;\n    this.filter();\n\n    if (oldSrc !== this.src) {\n      this.attempt = 0;\n      this.initState();\n    }\n  }\n\n  checkInView() {\n    const rect = useRect(this.el);\n    return rect.top < window.innerHeight * this.options.preLoad && rect.bottom > this.options.preLoadTop && rect.left < window.innerWidth * this.options.preLoad && rect.right > 0;\n  }\n\n  filter() {\n    Object.keys(this.options.filter).forEach(key => {\n      this.options.filter[key](this, this.options);\n    });\n  }\n\n  renderLoading(cb) {\n    this.state.loading = true;\n    loadImageAsync({\n      src: this.loading,\n      cors: this.cors\n    }, () => {\n      this.render(\"loading\", false);\n      this.state.loading = false;\n      cb();\n    }, () => {\n      cb();\n      this.state.loading = false;\n      if (process.env.NODE_ENV !== \"production\" && !this.options.silent) console.warn(`[@vant/lazyload] load failed with loading image(${this.loading})`);\n    });\n  }\n\n  load(onFinish = noop) {\n    if (this.attempt > this.options.attempt - 1 && this.state.error) {\n      if (process.env.NODE_ENV !== \"production\" && !this.options.silent) {\n        console.log(`[@vant/lazyload] ${this.src} tried too more than ${this.options.attempt} times`);\n      }\n\n      onFinish();\n      return;\n    }\n\n    if (this.state.rendered && this.state.loaded) return;\n\n    if (this.imageCache.has(this.src)) {\n      this.state.loaded = true;\n      this.render(\"loaded\", true);\n      this.state.rendered = true;\n      return onFinish();\n    }\n\n    this.renderLoading(() => {\n      var _a, _b;\n\n      this.attempt++;\n      (_b = (_a = this.options.adapter).beforeLoad) == null ? void 0 : _b.call(_a, this, this.options);\n      this.record(\"loadStart\");\n      loadImageAsync({\n        src: this.src,\n        cors: this.cors\n      }, data => {\n        this.naturalHeight = data.naturalHeight;\n        this.naturalWidth = data.naturalWidth;\n        this.state.loaded = true;\n        this.state.error = false;\n        this.record(\"loadEnd\");\n        this.render(\"loaded\", false);\n        this.state.rendered = true;\n        this.imageCache.add(this.src);\n        onFinish();\n      }, err => {\n        !this.options.silent && console.error(err);\n        this.state.error = true;\n        this.state.loaded = false;\n        this.render(\"error\", false);\n      });\n    });\n  }\n\n  render(state, cache) {\n    this.elRenderer(this, state, cache);\n  }\n\n  performance() {\n    let state = \"loading\";\n    let time = 0;\n\n    if (this.state.loaded) {\n      state = \"loaded\";\n      time = (this.performanceData.loadEnd - this.performanceData.loadStart) / 1e3;\n    }\n\n    if (this.state.error) state = \"error\";\n    return {\n      src: this.src,\n      state,\n      time\n    };\n  }\n\n  $destroy() {\n    this.el = null;\n    this.src = null;\n    this.error = null;\n    this.loading = null;\n    this.bindType = null;\n    this.attempt = 0;\n  }\n\n}\n\nexport { ReactiveListener as default };","map":{"version":3,"names":["useRect","loadImageAsync","noop","ReactiveListener","constructor","el","src","error","loading","bindType","$parent","options","cors","elRenderer","imageCache","attempt","naturalHeight","naturalWidth","performanceData","loadStart","loadEnd","filter","initState","render","dataset","setAttribute","state","loaded","rendered","record","event","Date","now","update","oldSrc","checkInView","rect","top","window","innerHeight","preLoad","bottom","preLoadTop","left","innerWidth","right","Object","keys","forEach","key","renderLoading","cb","process","env","NODE_ENV","silent","console","warn","load","onFinish","log","has","_a","_b","adapter","beforeLoad","call","data","add","err","cache","performance","time","$destroy","default"],"sources":["D:/项目/my-blog/node_modules/vant/es/lazyload/vue-lazyload/listener.mjs"],"sourcesContent":["import { useRect } from \"@vant/use\";\nimport { loadImageAsync } from \"./util.mjs\";\nimport { noop } from \"../../utils/index.mjs\";\nclass ReactiveListener {\n  constructor({\n    el,\n    src,\n    error,\n    loading,\n    bindType,\n    $parent,\n    options,\n    cors,\n    elRenderer,\n    imageCache\n  }) {\n    this.el = el;\n    this.src = src;\n    this.error = error;\n    this.loading = loading;\n    this.bindType = bindType;\n    this.attempt = 0;\n    this.cors = cors;\n    this.naturalHeight = 0;\n    this.naturalWidth = 0;\n    this.options = options;\n    this.$parent = $parent;\n    this.elRenderer = elRenderer;\n    this.imageCache = imageCache;\n    this.performanceData = {\n      loadStart: 0,\n      loadEnd: 0\n    };\n    this.filter();\n    this.initState();\n    this.render(\"loading\", false);\n  }\n  initState() {\n    if (\"dataset\" in this.el) {\n      this.el.dataset.src = this.src;\n    } else {\n      this.el.setAttribute(\"data-src\", this.src);\n    }\n    this.state = {\n      loading: false,\n      error: false,\n      loaded: false,\n      rendered: false\n    };\n  }\n  record(event) {\n    this.performanceData[event] = Date.now();\n  }\n  update({ src, loading, error }) {\n    const oldSrc = this.src;\n    this.src = src;\n    this.loading = loading;\n    this.error = error;\n    this.filter();\n    if (oldSrc !== this.src) {\n      this.attempt = 0;\n      this.initState();\n    }\n  }\n  checkInView() {\n    const rect = useRect(this.el);\n    return rect.top < window.innerHeight * this.options.preLoad && rect.bottom > this.options.preLoadTop && rect.left < window.innerWidth * this.options.preLoad && rect.right > 0;\n  }\n  filter() {\n    Object.keys(this.options.filter).forEach((key) => {\n      this.options.filter[key](this, this.options);\n    });\n  }\n  renderLoading(cb) {\n    this.state.loading = true;\n    loadImageAsync({\n      src: this.loading,\n      cors: this.cors\n    }, () => {\n      this.render(\"loading\", false);\n      this.state.loading = false;\n      cb();\n    }, () => {\n      cb();\n      this.state.loading = false;\n      if (process.env.NODE_ENV !== \"production\" && !this.options.silent)\n        console.warn(`[@vant/lazyload] load failed with loading image(${this.loading})`);\n    });\n  }\n  load(onFinish = noop) {\n    if (this.attempt > this.options.attempt - 1 && this.state.error) {\n      if (process.env.NODE_ENV !== \"production\" && !this.options.silent) {\n        console.log(`[@vant/lazyload] ${this.src} tried too more than ${this.options.attempt} times`);\n      }\n      onFinish();\n      return;\n    }\n    if (this.state.rendered && this.state.loaded)\n      return;\n    if (this.imageCache.has(this.src)) {\n      this.state.loaded = true;\n      this.render(\"loaded\", true);\n      this.state.rendered = true;\n      return onFinish();\n    }\n    this.renderLoading(() => {\n      var _a, _b;\n      this.attempt++;\n      (_b = (_a = this.options.adapter).beforeLoad) == null ? void 0 : _b.call(_a, this, this.options);\n      this.record(\"loadStart\");\n      loadImageAsync({\n        src: this.src,\n        cors: this.cors\n      }, (data) => {\n        this.naturalHeight = data.naturalHeight;\n        this.naturalWidth = data.naturalWidth;\n        this.state.loaded = true;\n        this.state.error = false;\n        this.record(\"loadEnd\");\n        this.render(\"loaded\", false);\n        this.state.rendered = true;\n        this.imageCache.add(this.src);\n        onFinish();\n      }, (err) => {\n        !this.options.silent && console.error(err);\n        this.state.error = true;\n        this.state.loaded = false;\n        this.render(\"error\", false);\n      });\n    });\n  }\n  render(state, cache) {\n    this.elRenderer(this, state, cache);\n  }\n  performance() {\n    let state = \"loading\";\n    let time = 0;\n    if (this.state.loaded) {\n      state = \"loaded\";\n      time = (this.performanceData.loadEnd - this.performanceData.loadStart) / 1e3;\n    }\n    if (this.state.error)\n      state = \"error\";\n    return {\n      src: this.src,\n      state,\n      time\n    };\n  }\n  $destroy() {\n    this.el = null;\n    this.src = null;\n    this.error = null;\n    this.loading = null;\n    this.bindType = null;\n    this.attempt = 0;\n  }\n}\nexport {\n  ReactiveListener as default\n};\n"],"mappings":"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"},"metadata":{},"sourceType":"module"}